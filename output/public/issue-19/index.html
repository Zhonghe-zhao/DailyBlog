<!DOCTYPE html>
<html lang="en">
    <head>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta http-equiv="content-type" content="text/html; charset=utf-8">

      <!-- Enable responsiveness on mobile devices-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0">

    
      
    

      <title> - Golang In Deep</title>

      
          
          <link rel="alternate" type="application/rss+xml" title="RSS" href="https://Zhonghe-zhao.github.io/DailyBlog/rss.xml">
          
      

      
          <script src="https://cdnjs.cloudflare.com/ajax/libs/slideout/1.0.1/slideout.min.js"></script>
          
      

      
          <link rel="stylesheet" href="https://Zhonghe-zhao.github.io/DailyBlog/site.css">
          
      

      
      
    </head>

    <body>
        <div class="container">

            <div id="mobile-navbar" class="mobile-navbar">
              <div class="mobile-header-logo">
                <a href="https:&#x2F;&#x2F;Zhonghe-zhao.github.io&#x2F;DailyBlog&#x2F;" class="logo"></a>
              </div>
              <div class="mobile-navbar-icon icon-out">
                <span></span>
                <span></span>
                <span></span>
              </div>
            </div>

            <nav id="mobile-menu" class="mobile-menu slideout-menu slideout-menu-left">
              <ul class="mobile-menu-list">
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;Zhonghe-zhao.github.io&#x2F;DailyBlog&#x2F;">
                            Home
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;Zhonghe-zhao.github.io&#x2F;DailyBlog&#x2F;&#x2F;tags&#x2F;top&#x2F;">
                            Top
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;Zhonghe-zhao.github.io&#x2F;DailyBlog&#x2F;&#x2F;issue-34&#x2F;">
                            About
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;Zhonghe-zhao.github.io&#x2F;DailyBlog&#x2F;&#x2F;issue-35&#x2F;">
                            Things I like
                        </a>
                    </li>
                
              </ul>
            </nav>

            <header id="header">
                <div class="logo"><a href="https:&#x2F;&#x2F;Zhonghe-zhao.github.io&#x2F;DailyBlog&#x2F;"></a></div>
                <nav class="menu">
                    <ul>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;Zhonghe-zhao.github.io&#x2F;DailyBlog&#x2F;">
                                    Home
                                </a>
                            </li>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;Zhonghe-zhao.github.io&#x2F;DailyBlog&#x2F;&#x2F;tags&#x2F;top&#x2F;">
                                    Top
                                </a>
                            </li>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;Zhonghe-zhao.github.io&#x2F;DailyBlog&#x2F;&#x2F;issue-34&#x2F;">
                                    About
                                </a>
                            </li>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;Zhonghe-zhao.github.io&#x2F;DailyBlog&#x2F;&#x2F;issue-35&#x2F;">
                                    Things I like
                                </a>
                            </li>
                        
                    </ul>
                </nav>
            </header>

            <main>
                <div class="content" id="mobile-panel">
                    


<div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">Contents</h2>
    <div class="post-toc-content always-active">
        <nav id="TableOfContents">
            <ul>
                
                <li>
                    <a href="https://Zhonghe-zhao.github.io/DailyBlog/issue-19/#gmpmo-xing" class="toc-link">GMP模型</a>
                    
                    <ul>
                        
                        <li>
                            <a href="https://Zhonghe-zhao.github.io/DailyBlog/issue-19/#wei-shen-me-goroutineqie-huan-bi-xian-cheng-qing-liang" class="toc-link">为什么goroutine切换比线程轻量？</a>
                        </li>
                        
                        <li>
                            <a href="https://Zhonghe-zhao.github.io/DailyBlog/issue-19/#mru-he-zhi-jie-diao-du-g" class="toc-link">M如何直接调度G</a>
                        </li>
                        
                        <li>
                            <a href="https://Zhonghe-zhao.github.io/DailyBlog/issue-19/#fa-sheng-zu-sai-zen-me-ban" class="toc-link">发生阻塞怎么办</a>
                        </li>
                        
                    </ul>
                    
                </li>
                
            </ul>
        </nav>
    </div>
</div>


<article class="post">
    
    <header class="post__header">
        <h1 class="post__title">
            <a href="https:&#x2F;&#x2F;Zhonghe-zhao.github.io&#x2F;DailyBlog&#x2F;issue-19&#x2F;">Golang In Deep</a>
        </h1>
        <div class="post__meta">
            <span class="post__time">2025-06-11</span>
            
                <span class="post__source">
                    <a href="https:&#x2F;&#x2F;github.com&#x2F;Zhonghe-zhao&#x2F;DailyBlog&#x2F;issues&#x2F;19">read the source issue</a>
                </span>
            
            
        </div>
    </header>


    <div class="post-reactions">
        
        
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
    </div>

    <div class="post-content">
      <h1 id="gmpmo-xing">GMP模型</h1>
<p>首先思考 GMP调度模型是什么？ 为了解决什么问题？</p>
<p>引出下文：</p>
<p>GMP是 Go runtime的一个调度模型， 调度模型是什么？ Go runtime是什么？</p>
<p><strong>Go runtime：</strong> Go runtime 是 Go 语言自带的一套 运行时系统。</p>
<p>他自己有一套功能：</p>
<ol>
<li>GMP调度器</li>
<li>垃圾回收GC</li>
<li>系统调用封装 等</li>
</ol>
<p>因为GO需要自己管理这些情况 所以需要内置 runtime</p>
<p>**调度模型： **系统如何决定“哪个任务（线程、协程）由哪个 CPU 在什么时候执行”的策略和机制。</p>
<p>Go 调度器运行在用户态，负责调度 goroutine 到 Go 自己维护的 M（线程） 上。</p>
<h2 id="wei-shen-me-goroutineqie-huan-bi-xian-cheng-qing-liang">为什么goroutine切换比线程轻量？</h2>
<p><strong>线程就是操作系统里执行代码的最小单位。</strong></p>
<p>首先清楚： <em>上下文越大，切换开销越大（保存/恢复更多信息）</em></p>
<h3 id="xian-cheng-shi-bing-fa-bian-cheng-de-ji-chu">线程是并发编程的基础</h3>
<p><strong>线程内代码按顺序执行。多个线程通过 CPU 多核或调度实现任务并行或并发，提高效率。</strong></p>
<p>回到最初！因为os线程的并发下 开销大！ 所以Go设计了用户级goruntine 目前的问题就是 如何<strong>把成千上万的goroutine 高效的调度到有限的os上</strong></p>
<p>用户级别的协程确实在开销上非常小 目前的问题就是 如何将协程和线程连接起来 从而让真正的CPU去工作</p>
<p>Goroutine的执行条件是什么？</p>
<p>CPU状态 任务队列 本地缓存 调度信息</p>
<p>这些环境谁来提供？</p>
<p>p！</p>
<p>p 管理能运行多少个G 协调 本地队列 与 全局队列</p>
<p>谁来维护p？</p>
<p>CPU核数 限制了 p的数量</p>
<p>M 是操作系统的线程，是实际能被 CPU 调度执行的实体 M必须绑定p 才能执行G</p>
<p>P调度G M执行G</p>
<p>为什么 只有绑定P才能执行G 早期没有P是如何运行的？</p>
<h2 id="mru-he-zhi-jie-diao-du-g">M如何直接调度G</h2>
<p>有哪些缺点?</p>
<p>M 同时负责调度和执行，导致调度逻辑复杂且不够高效。 容易出现资源竞争和瓶颈。</p>
<h2 id="fa-sheng-zu-sai-zen-me-ban">发生阻塞怎么办</h2>
<p>什么会发生阻塞？</p>
<p><strong>I/O阻塞：</strong> 程序必须完成某个程序的输入输出 才能执行后续的代码</p>
<p>M属于内核级别 M发生系统调用 M会被操作系统挂起，进入阻塞状态</p>
<p>Go检测到阻塞就会就会让M释放P 创建或唤醒另一个M去绑定这个P然后执行G，被挂起的 M 等调用完成后再尝试回收利用。</p>
<p>Go的runtime做法， 发现这个G是阻塞的 就从当前M中剥离这个G 然后G标记waiting 把p解绑 交给别的M</p>
<h3 id="xi-tong-diao-yong-wei-shen-me-hui-zu-sai">系统调用为什么会阻塞</h3>
<p>运行在用户态 去请求 系统内核的某些权限!(文件读写， 网络通信，进程管理)</p>
<ol>
<li>
<p>读取磁盘文件可能需要等待磁盘控制器返回数据</p>
</li>
<li>
<p>网络 I/O：接收网络数据（如 net.Conn.Read）需要等待客户端发送数据。</p>
</li>
<li>
<p>进程同步：如 waitpid 等待子进程退出。</p>
</li>
</ol>
<h3 id="yi-huo">疑惑：</h3>
<p>所以说 系统调用 为什么会阻塞？ 如果当系统调用需要从磁盘读取数据的时候 线程去执行其它资源，然后等数据返回再去执行，这样不就大大提高了利用率吗？</p>
<h3 id="hui-da">回答:</h3>
<p>这个问题就是<strong>同步阻塞I/O模型</strong></p>
<p>让线程去做别的事情就是 <strong>异步非阻塞模型:</strong> 这样一个线程可以管理成千上万个 I/O 连接，提高吞吐量。</p>

    </div>

    

    
        <div class="post-comments">
            
                <div class="comment-item">
                    <div class="comment-author">
                        <a href="https:&#x2F;&#x2F;github.com&#x2F;Zhonghe-zhao&#x2F;DailyBlog&#x2F;issues&#x2F;19#issuecomment-2965055764">
                            <img src="https:&#x2F;&#x2F;avatars.githubusercontent.com&#x2F;u&#x2F;147113943?v=4" alt="avatar">
                            <span class="comment-author-name">Zhonghe-zhao</span>
                            <span class="comment-date">2025-06-12 04:14</span>
                        </a>
                    </div>
                    <div class="comment-content">
                        <h1 id="newyu-make">new与make</h1>
<h2 id="new-han-shu"><strong>new 函数：</strong></h2>
<p>"将内存初始化为类型的零值 然后返回指针"</p>
<p>零值是什么？</p>
<ul>
<li>数值类型（int/float等）：0</li>
<li>bool：false</li>
<li>string：""（空字符串）</li>
<li>指针/slice/map/channel/interface：nil</li>
<li>结构体：所有字段都是各自类型的零值</li>
</ul>
<p>new(T) 为类型T 分配内存空间 并将内存中的值设置为T的零值 返回指向这块内存的指针</p>
<h2 id="makehan-shu">**make函数: **</h2>
<p>专用于 <strong>slice map channel</strong>   做特定类型的<strong>初始化</strong></p>
<pre data-lang="go" class="language-go "><code class="language-go" data-lang="go">&#x2F;&#x2F; 切片
s := make([]T, length, capacity)  &#x2F;&#x2F; capacity 可省略

&#x2F;&#x2F; 映射
m := make(map[K]V)  &#x2F;&#x2F; 可加初始容量参数：make(map[K]V, initialCapacity)

&#x2F;&#x2F; 通道
ch := make(chan T)    &#x2F;&#x2F; 无缓冲通道
ch := make(chan T, n) &#x2F;&#x2F; 带缓冲通道，缓冲区大小 n
</code></pre>
<p><strong>对于切片：</strong></p>
<p>创建底层数组 初始化长度与容量 所有元素设置为0值</p>
<p><strong>对于map</strong></p>
<p>初始化哈希表的数据结构 准备后续的键值对存储</p>
<p><strong>对于channel</strong></p>
<p>初始化缓冲区 设置同步所需的内部数据结构</p>

                    </div>
                </div>
            
                <div class="comment-item">
                    <div class="comment-author">
                        <a href="https:&#x2F;&#x2F;github.com&#x2F;Zhonghe-zhao&#x2F;DailyBlog&#x2F;issues&#x2F;19#issuecomment-2973596303">
                            <img src="https:&#x2F;&#x2F;avatars.githubusercontent.com&#x2F;u&#x2F;147113943?v=4" alt="avatar">
                            <span class="comment-author-name">Zhonghe-zhao</span>
                            <span class="comment-date">2025-06-15 08:47</span>
                        </a>
                    </div>
                    <div class="comment-content">
                        <h1 id="map">Map</h1>
<p>关键点涉及： 并发安全！</p>
<h2 id="bing-fa-an-quan">并发安全！</h2>
<p>当多个线程或协程同时访问共享资源时，程序依然能正常运行，数据不会出错。</p>
<p>考虑 是否需要同步， 是否有资源竞争， 是否有读写冲突？</p>
<p><em>sync.Map</em> 用于并发</p>
<h2 id="why">Why？</h2>
<p>为什么对普通的map进行并发操作会导致问题 ：</p>
<p>首先Map底层是</p>
<p>哈希表：</p>
<p>多个 goroutine 同时读写 map 的同一桶或元数据，可能导致内存访问冲突</p>
<p>Go 的 map 底层是一个哈希表，哈希表把键值对分组存储在“桶”中。每个桶可以存多个键值对。
比如，键 "apple" 和 "banana" 通过哈希函数可能被分配到同一个桶里。</p>
<p>Map的桶：</p>

                    </div>
                </div>
            
        </div>
    

    

    <div class="post-footer">
        
            
                <div class="post-tags">
                    
                        <a href="https://Zhonghe-zhao.github.io/DailyBlog/tags/go/">#Go</a>
                    
                </div>
            
            
                <div class="post-nav">
                    
                        <a class="previous" href="https:&#x2F;&#x2F;Zhonghe-zhao.github.io&#x2F;DailyBlog&#x2F;issue-20&#x2F;">‹ 一些前沿资料获取</a>
                    
                    
                        <a class="next" href="https:&#x2F;&#x2F;Zhonghe-zhao.github.io&#x2F;DailyBlog&#x2F;issue-18&#x2F;">与北邮老哥的交谈 ›</a>
                    
                </div>
            

        

    </div>

    
    
</article>


                </div>
            </main>

            
            
        </div>

      
          <script type="text/javascript" src="https://Zhonghe-zhao.github.io/DailyBlog/even.js" ></script>
      
    </body>

</html>
