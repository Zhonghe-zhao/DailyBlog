<!DOCTYPE html>
<html lang="en">
    <head>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta http-equiv="content-type" content="text/html; charset=utf-8">

      <!-- Enable responsiveness on mobile devices-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0">

    
      
    

      <title> - Go By Mistakes</title>

      
          
          <link rel="alternate" type="application/rss+xml" title="RSS" href="https://Zhonghe-zhao.github.io/DailyBlog/rss.xml">
          
      

      
          <script src="https://cdnjs.cloudflare.com/ajax/libs/slideout/1.0.1/slideout.min.js"></script>
          
      

      
          <link rel="stylesheet" href="https://Zhonghe-zhao.github.io/DailyBlog/site.css">
          
      

      
      
    </head>

    <body>
        <div class="container">

            <div id="mobile-navbar" class="mobile-navbar">
              <div class="mobile-header-logo">
                <a href="https:&#x2F;&#x2F;Zhonghe-zhao.github.io&#x2F;DailyBlog&#x2F;" class="logo"></a>
              </div>
              <div class="mobile-navbar-icon icon-out">
                <span></span>
                <span></span>
                <span></span>
              </div>
            </div>

            <nav id="mobile-menu" class="mobile-menu slideout-menu slideout-menu-left">
              <ul class="mobile-menu-list">
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;Zhonghe-zhao.github.io&#x2F;DailyBlog&#x2F;">
                            Home
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;Zhonghe-zhao.github.io&#x2F;DailyBlog&#x2F;&#x2F;tags&#x2F;top&#x2F;">
                            Top
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;Zhonghe-zhao.github.io&#x2F;DailyBlog&#x2F;&#x2F;issue-34&#x2F;">
                            About
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;Zhonghe-zhao.github.io&#x2F;DailyBlog&#x2F;&#x2F;issue-35&#x2F;">
                            Things I like
                        </a>
                    </li>
                
              </ul>
            </nav>

            <header id="header">
                <div class="logo"><a href="https:&#x2F;&#x2F;Zhonghe-zhao.github.io&#x2F;DailyBlog&#x2F;"></a></div>
                <nav class="menu">
                    <ul>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;Zhonghe-zhao.github.io&#x2F;DailyBlog&#x2F;">
                                    Home
                                </a>
                            </li>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;Zhonghe-zhao.github.io&#x2F;DailyBlog&#x2F;&#x2F;tags&#x2F;top&#x2F;">
                                    Top
                                </a>
                            </li>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;Zhonghe-zhao.github.io&#x2F;DailyBlog&#x2F;&#x2F;issue-34&#x2F;">
                                    About
                                </a>
                            </li>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;Zhonghe-zhao.github.io&#x2F;DailyBlog&#x2F;&#x2F;issue-35&#x2F;">
                                    Things I like
                                </a>
                            </li>
                        
                    </ul>
                </nav>
            </header>

            <main>
                <div class="content" id="mobile-panel">
                    


<div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">Contents</h2>
    <div class="post-toc-content always-active">
        <nav id="TableOfContents">
            <ul>
                
                <li>
                    <a href="https://Zhonghe-zhao.github.io/DailyBlog/issue-11/#inithan-shu-de-shi-yong" class="toc-link">init函数的使用</a>
                    
                    <ul>
                        
                        <li>
                            <a href="https://Zhonghe-zhao.github.io/DailyBlog/issue-11/#ce-shi" class="toc-link">测试</a>
                        </li>
                        
                        <li>
                            <a href="https://Zhonghe-zhao.github.io/DailyBlog/issue-11/#quan-ju-bian-liang" class="toc-link">全局变量</a>
                        </li>
                        
                    </ul>
                    
                </li>
                
            </ul>
        </nav>
    </div>
</div>


<article class="post">
    
    <header class="post__header">
        <h1 class="post__title">
            <a href="https:&#x2F;&#x2F;Zhonghe-zhao.github.io&#x2F;DailyBlog&#x2F;issue-11&#x2F;">Go By Mistakes</a>
        </h1>
        <div class="post__meta">
            <span class="post__time">2025-05-30</span>
            
                <span class="post__source">
                    <a href="https:&#x2F;&#x2F;github.com&#x2F;Zhonghe-zhao&#x2F;DailyBlog&#x2F;issues&#x2F;11">read the source issue</a>
                </span>
            
            
        </div>
    </header>


    <div class="post-reactions">
        
        
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
    </div>

    <div class="post-content">
      <h1 id="inithan-shu-de-shi-yong">init函数的使用</h1>
<p>在<code>init()</code>函数中，不能返回错误，因为init函数的作用是 完成初始化 或者直接使用<code>panic()</code>终止程序 ！</p>
<h2 id="ce-shi">测试</h2>
<p>在测试之前</p>
<ol>
<li>Go总会加载相关包</li>
<li>自动调用包中的所有<code>init()</code>函数</li>
</ol>
<p><strong>执行顺序</strong>： 测试加载顺序：包级变量初始化 → init() 执行 → TestMain()（如果存在）→ TestXxx() 执行。</p>
<h3 id="zhu-yi"><strong>注意：</strong></h3>
<p>init() 是全局性的，一旦定义就会在所有测试前执行
所以如果你在某个文件中写了一个 init()，它无法按需控制是否执行，这会给某些不需要它的测试带来副作用。</p>
<h3 id="shi-li">示例：</h3>
<p>如果你在一个文件中定义了</p>
<pre data-lang="go" class="language-go "><code class="language-go" data-lang="go">&#x2F;&#x2F; utils.go
func HashPassword(pw string) string {
    &#x2F;&#x2F; 哈希逻辑
}
</code></pre>
<pre data-lang="go" class="language-go "><code class="language-go" data-lang="go">func init() {
    &#x2F;&#x2F; 建立数据库连接
    db, _ = sql.Open(&quot;postgres&quot;, &quot;...&quot;)
}
</code></pre>
<p>你只想测试 HashPassword()，跟数据库没关系，但：</p>
<p>Go 会强制执行 init() → 建立数据库连接</p>
<p>如果数据库挂了、网络断了，测试失败</p>
<p>即使测试内容跟数据库一毛钱关系都没有</p>
<p>init() 是文件级别、不可控制的初始化逻辑，一旦存在，它就会对这个包的所有使用者和测试者产生影响。</p>
<p><strong>做法：</strong></p>
<p>尽量避免在 init() 中建立全局连接或启动重逻辑 不要用 init() 连数据库</p>
<p>把数据库连接从 init() 拆出去，改成显式初始化函数，这样测试更灵活、代码更可控、依赖更清晰</p>
<pre data-lang="go" class="language-go "><code class="language-go" data-lang="go">var DB *sql.DB

func InitDB(dsn string) error {
	var err error
	DB, err = sql.Open(&quot;postgres&quot;, dsn)
	return err
}
</code></pre>
<h2 id="quan-ju-bian-liang">全局变量</h2>
<p>如果把数据库连接对象赋值给全局变量（如 var db *sql.DB），为什么这会让单元测试变复杂、变得“不隔离”？</p>
<h3 id="shi-li-1">示例：</h3>
<pre data-lang="go" class="language-go "><code class="language-go" data-lang="go">&#x2F;&#x2F; user.go
package user

import &quot;yourproject&#x2F;db&quot;

func GetUserByID(id int) (*User, error) {
	return db.DB.Query(...) &#x2F;&#x2F; 用的是全局变量 db.DB
}
</code></pre>
<p>它依赖的是全局变量 db.DB，你没法注入 mock 数据库(全局变量在代码里写死了，函数内部直接引用它，测试时你没法“替换”这个变量指向别的对象)，也无法用内存数据库替代。</p>
<h3 id="jie-jue">解决：</h3>
<p>将 DB 作为参数而不是全局变量</p>
<pre data-lang="go" class="language-go "><code class="language-go" data-lang="go">&#x2F;&#x2F; user.go
type UserRepo struct {
	DB *sql.DB
}

func (r *UserRepo) GetUserByID(id int) (*User, error) {
	return r.DB.Query(...)
}
</code></pre>
<p>main.go</p>
<pre data-lang="go" class="language-go "><code class="language-go" data-lang="go">db, _ := sql.Open(...)
repo := user.UserRepo{DB: db}
</code></pre>
<p>测试中</p>
<pre data-lang="go" class="language-go "><code class="language-go" data-lang="go">fakeDB := NewFakeDB() &#x2F;&#x2F; 或用 sqlite、mock
repo := user.UserRepo{DB: fakeDB}
</code></pre>
<pre data-lang="go" class="language-go "><code class="language-go" data-lang="go">&#x2F;&#x2F; db_test.go
package db

import (
	&quot;fmt&quot;
	&quot;testing&quot;
)

func Test_Global_DB(t *testing.T) {
	DB = &quot;RealDB&quot;
	got := GetUserGlobal(1)
	fmt.Println(got)

	DB = &quot;MockDB&quot; &#x2F;&#x2F; ← 修改全局变量

	got2 := GetUserGlobal(1)
	fmt.Println(got2)
	&#x2F;&#x2F; 问题：前后结果不一致，测试间共享状态
}

func Test_DI_DB(t *testing.T) {
	real := &amp;DBClient{DB: &quot;RealDB&quot;}
	mock := &amp;DBClient{DB: &quot;MockDB&quot;}

	got := real.GetUserDI(1)
	fmt.Println(got)

	got2 := mock.GetUserDI(1)
	fmt.Println(got2)
	&#x2F;&#x2F; 优点：各自隔离，不会互相影响
}
</code></pre>

    </div>

    

    

    

    <div class="post-footer">
        
            
                <div class="post-tags">
                    
                        <a href="https://Zhonghe-zhao.github.io/DailyBlog/tags/development/">#Development</a>
                    
                        <a href="https://Zhonghe-zhao.github.io/DailyBlog/tags/go/">#Go</a>
                    
                </div>
            
            
                <div class="post-nav">
                    
                        <a class="previous" href="https:&#x2F;&#x2F;Zhonghe-zhao.github.io&#x2F;DailyBlog&#x2F;issue-12&#x2F;">‹ Grokking Concurrency</a>
                    
                    
                        <a class="next" href="https:&#x2F;&#x2F;Zhonghe-zhao.github.io&#x2F;DailyBlog&#x2F;issue-10&#x2F;">Copy-On-Write ›</a>
                    
                </div>
            

        

    </div>

    
    
</article>


                </div>
            </main>

            
            
        </div>

      
          <script type="text/javascript" src="https://Zhonghe-zhao.github.io/DailyBlog/even.js" ></script>
      
    </body>

</html>
